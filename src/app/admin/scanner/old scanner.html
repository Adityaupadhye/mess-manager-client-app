<app-navbar></app-navbar>

<div class="container min-h-screen bg-gray-50 pt-8 pb-10 px-3">
  <div class="max-w-screen-2xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- LEFT SIDE -->
    <section class="flex flex-col gap-6">

      <!-- MEAL SELECTOR -->
      <div class="bg-white rounded-lg shadow p-4 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
          <span class="material-icons text-blue-600">restaurant</span>
          Current Meal
        </h3>

        <!-- FIX: mat-form-field needs its own wrapper & cannot be inside flex-shrink container -->
        <div class="w-48">
          <mat-form-field appearance="fill" class="w-full">
            <mat-select [(value)]="currentFoodCategory">
              <mat-option *ngFor="let category of foodCategories" [value]="category">
                {{ category.toUpperCase() }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- SCANNER BOX -->
      <div class="relative rounded-lg overflow-hidden shadow bg-gradient-to-b from-slate-800 to-slate-700 h-80">

        <!-- FIX: ensure scanner is not blocking UI outside -->
        <div class="absolute inset-0 z-0">
          <zxing-scanner class="w-full h-full" (scanSuccess)="onScanSuccess($event)" [autofocusEnabled]="true"
            [enable]="isScanningEnabled" (camerasFound)="onCamerasFound($event)"
            (camerasNotFound)="onCameraError($event)" (permissionResponse)="hasPermission = $event"
            [device]="selectedDevice" [delayBetweenScanSuccess]="2000">
          </zxing-scanner>
        </div>

        <!-- CAMERA OFF OVERLAY -->
        <div *ngIf="!isScanningEnabled"
          class="absolute inset-0 z-10 flex flex-col items-center justify-center text-white/70 pointer-events-none">
          <span class="material-icons text-6xl">photo_camera</span>
          <p class="mt-2">Camera is Off</p>
        </div>
      </div>

      <!-- BUTTONS -->
      <div class="grid grid-cols-2 gap-4">
        <button class="rounded-lg py-3 bg-black text-white hover:bg-gray-800 flex items-center justify-center gap-2"
          (click)="toggleScanning()">
          <span class="material-icons">
            {{ isScanningEnabled ? 'videocam_off' : 'videocam' }}
          </span>
          {{ isScanningEnabled ? 'Turn Off Scanner' : 'Turn On Scanner' }}
        </button>

        <button class="rounded-lg py-3 bg-white border border-black text-black hover:bg-gray-800
                       flex items-center justify-center gap-2" (click)="resetScanner()">
          <span class="material-icons">restart_alt</span>
          Reset Scanner
        </button>
      </div>

      <!-- CAMERA SELECTOR -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
          <span class="material-icons text-gray-700">photo_camera_front</span>
          Select Camera
        </label>

        <mat-form-field appearance="fill" class="w-full">
          <mat-select [(value)]="selectedDevice" (selectionChange)="onDeviceChange($event.value)">
            <mat-option *ngFor="let device of availableDevices; let i = index" [value]="device">
              {{ device.label || ('Camera ' + (i + 1)) }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </section>


    <!-- RIGHT SIDE -->
    <section class="flex flex-col gap-6">

      <!-- USER INFO -->
      <div *ngIf="_hasScanningStarted && !_scanningError"
        class="p-4 bg-gray-900 text-white rounded-lg shadow flex gap-6 items-center">

        <!-- PROFILE IMAGE -->
        <div class="w-40 h-40 rounded-lg bg-white/20 flex items-center justify-center overflow-hidden">
          <span class="material-icons text-8xl text-white/60">person</span>
        </div>

        <!-- USER DETAILS -->
        <div class="flex flex-col justify-center">
          <label class="text-sm opacity-80">NAME</label>
          <p class="text-4xl font-bold mb-2">{{ studentData.name || '-' }}</p>

          <label class="text-sm opacity-80">ROLL NUMBER</label>
          <p class="text-2xl font-semibold mb-2">{{ studentData.roll_no || '-' }}</p>

          <label class="text-sm opacity-80">HOSTEL</label>
          <p class="text-2xl font-semibold">{{ studentData.hostel || '-' }}</p>
        </div>
      </div>

      <!-- SUCCESS ALERT -->
      <div *ngIf="_hasScanningStarted && !_scanningError && !userValidityError"
        class="p-4 bg-green-600 text-white rounded-lg shadow">

        <div class="flex items-center gap-3 mb-2">
          <span class="material-icons text-6xl">check_circle</span>
          <p class="text-4xl font-bold">ALLOWED</p>
        </div>

        <p class="text-xl opacity-90 mb-2">Enjoy your meal!</p>

        <div class="bg-white/10 p-3 rounded-lg text-lg grid grid-cols-2 gap-y-2">
          <div>Meal Type:</div>
          <div class="text-right font-semibold text-lg">{{ currentFoodCategory || '-' }}</div>

          <div>Time:</div>
          <div class="text-right font-semibold text-lg">
            {{ currentScannedUser
            ? ((currentScannedUser.timestamp * 1000) | date:'dd MMM yyyy, hh:mm:ss a')
            : 'N/A'
            }}
          </div>
        </div>
      </div>

      <!-- ERROR ALERT -->
      <div *ngIf="_hasScanningStarted && (userValidityError || _scanningError)"
        class="p-4 bg-red-600 text-white rounded-lg shadow">

        <div class="flex items-center gap-3 mb-2">
          <span class="material-icons text-6xl">error</span>
          <p class="text-4xl font-bold">
            {{ _scanningError ? 'INVALID QR CODE' : 'NOT ALLOWED' }}
          </p>
        </div>

        <p class="text-xl opacity-90 mb-2">
          {{ _scanningError ? 'Invalid QR code scanned' : userValidityError }}
        </p>

        <div class="bg-white/10 p-3 rounded-lg text-lg grid grid-cols-2 gap-y-2">
          <div>Last Scan Time:</div>
          <div class="text-right font-semibold text-lg">
            {{ currentScannedUser
            ? ((currentScannedUser.timestamp * 1000) | date:'dd MMM yyyy, hh:mm:ss a')
            : 'N/A'
            }}
          </div>

          <div>Roll Number:</div>
          <div class="text-right font-semibold text-lg">{{ studentData?.roll_no || '-' }}</div>

          <div>Hostel:</div>
          <div class="text-right font-semibold text-lg">{{ studentData?.hostel || '-' }}</div>
        </div>
      </div>

    </section>


  </div>
</div>